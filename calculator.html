<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Calculator</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="main-container">
        <div class="calculator">
            <h2>Calculator</h2>
            <div class="display" id="display">0</div>
            <div class="buttons">
                <button class="clear" onclick="clearDisplay()">C</button>
                <button class="backspace" onclick="deleteLastDigit()">&#9003;</button>
                <button class="operator" onclick="appendOperator('/')">/</button>
                <button class="operator" onclick="appendOperator('*')">Ã—</button>
    
                <button class="number" onclick="appendNumber('7')">7</button>
                <button class="number" onclick="appendNumber('8')">8</button>
                <button class="number" onclick="appendNumber('9')">9</button>
                <button class="operator" onclick="appendOperator('-')">-</button>
    
                <button class="number" onclick="appendNumber('4')">4</button>
                <button class="number" onclick="appendNumber('5')">5</button>
                <button class="number" onclick="appendNumber('6')">6</button>
                <button class="operator" onclick="appendOperator('+')">+</button>
    
                <button class="number" onclick="appendNumber('1')">1</button>
                <button class="number" onclick="appendNumber('2')">2</button>
                <button class="number" onclick="appendNumber('3')">3</button>
                <button class="number" onclick="appendNumber('.')">.</button>
    
                <button class="number zero" onclick="appendNumber('0')">0</button>
                <button class="equals" onclick="calculate()">=</button>
            </div>
        </div>
        
        <div class="history-panel">
            <h3>History</h3>
            <ul class="history-list" id="historyList">
                </ul>
        </div>
    </div>

    <script>
        let display = document.getElementById('display');
        let expression = '';

        function updateDisplay() {
            display.textContent = expression || '0';
        }

        function clearDisplay() {
            expression = '';
            display.classList.remove('error');
            updateDisplay();
        }

        function appendNumber(num) {
            // Prevent multiple decimals in the same number segment
            if (num === '.') {
                const operators = ['+', '-', '*', '/'];
                const parts = expression.split(/[\+\-\*\/]/);
                const currentPart = parts[parts.length - 1];
                if (currentPart.includes('.')) return;
            }
            
            if (expression === '0' && num !== '.') {
                expression = num;
            } else {
                expression += num;
            }
            updateDisplay();
        }

        function appendOperator(op) {
            const operators = ['+', '-', '*', '/'];
            
            // Allow negative sign at start
            if (expression === '' && op === '-') {
                expression += op;
                updateDisplay();
                return;
            }
            
            if (expression === '') return;

            const lastChar = expression.slice(-1);
        
            if (operators.includes(lastChar)) {
                if (op === '-' && lastChar !== '-') {
                    expression += op;
                } else {
                    // Replace the operator
                    expression = expression.slice(0, -1) + op;
                }
            } else {
                expression += op;
            }
            updateDisplay();
        }

        function calculate() {
            try {
                if (!expression) return;
                
                // Prepare expression for calculating
                let evalExpr = expression;
                const operators = ['+', '-', '*', '/'];

                // If expression ends with an operator, duplicate the last entered number
                // Example: "5-" -> use "5-5"; "12+3-" -> use "12+3-3"
                const lastChar = expression.slice(-1);
                if (operators.includes(lastChar)) {
                    // Find the last operator position that is not a unary minus
                    let lastOpIndex = -1;
                    for (let i = expression.length - 1; i >= 0; i--) {
                        const ch = expression[i];
                        if (operators.includes(ch)) {
                            if (ch === '-' && (i === 0 || operators.includes(expression[i - 1]))) {
                                // unary minus, skip
                                continue;
                            }
                            lastOpIndex = i;
                            break;
                        }
                    }

                    if (lastOpIndex !== -1) {
                        const leftExpr = expression.slice(0, lastOpIndex);
                        const op = expression[lastOpIndex];

                        // Extract the last number from leftExpr (handles negative numbers)
                        const numMatch = leftExpr.match(/(-?\d+(?:\.\d+)?)$/);
                        let lastNumber = '0';
                        if (numMatch) {
                            lastNumber = numMatch[0];
                            // If leftExpr is just the last number (no preceding expr), preserve it as-is
                        } else if (leftExpr !== '') {
                            // Fallback: use whole leftExpr if no number found
                            lastNumber = leftExpr;
                        } else {
                            // Nothing to duplicate; fall back to trimming trailing operators
                            let tmp = evalExpr;
                            while (operators.includes(tmp.slice(-1))) tmp = tmp.slice(0, -1);
                            evalExpr = tmp;
                        }

                        if (lastNumber !== '') {
                            evalExpr = leftExpr + op + lastNumber;
                        }
                    } else {
                        // No valid operator found (e.g., expression is just "-"), trim trailing operators
                        while (operators.includes(evalExpr.slice(-1))) {
                            evalExpr = evalExpr.slice(0, -1);
                        }
                    }
                } else {
                    // Regular case: remove any accidental trailing operators
                    while (operators.includes(evalExpr.slice(-1))) {
                        evalExpr = evalExpr.slice(0, -1);
                    }
                }

                // Safe evaluation
                let result = new Function('return ' + evalExpr)();
                
                if (!isFinite(result)) {
                    display.classList.add('error');
                    expression = 'Cannot divide by zero!';
                    updateDisplay();
                    // Reset after a delay or next click
                    setTimeout(() => { 
                        expression = ''; 
                        display.classList.remove('error');
                        updateDisplay();
                    }, 2000);
                    return;
                }

                // Add to history
                addToHistory(evalExpr, result);

                // Update expression to result for next calculation
                expression = result.toString();
                updateDisplay();

            } catch (e) {
                display.textContent = 'Error';
                expression = '';
            }
        }
        
        // Keyboard support (Merged from Main Branch)
        function deleteLastChar() {
            expression = expression.slice(0, -1);
            updateDisplay();
        }

        document.addEventListener('keydown', function(event) {
            const key = event.key;
            
            if (/[0-9]/.test(key)) {
                appendNumber(key);
            } else if (key === '+' || key === '-' || key === '*' || key === '/') {
                appendOperator(key);
            } else if (key === 'Enter' || key === '=') {
                event.preventDefault(); // Prevent accidental form submissions
                calculate();
            } else if (key === 'Escape' || key.toLowerCase() === 'c') {
                clearDisplay();
            } else if (key === '.') {
                appendNumber('.');
            } else if (key === 'Backspace') {
                deleteLastChar();
            } else if (key === 'Delete') {
                clearDisplay();
            }
        });

        // History Feature 
        let history = [];
        const MAX_HISTORY = 10;
        const historyList = document.getElementById('historyList');

        function addToHistory(expr, res) {
            const entry = `${expr} = ${res}`;
            history.unshift(entry);
            if (history.length > MAX_HISTORY) {
                history.pop();
            }
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            historyList.innerHTML = '';
            history.forEach(entry => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.textContent = entry;
                historyList.appendChild(li);
            });
        }
    </script>
</body>
</html>